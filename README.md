# 海龟汤 · Situation Puzzle Game

基于 AI 主持人的线上「海龟汤」情境推理游戏。用户选择汤的类型（清汤 / 红汤 / 黑汤），通过封闭式提问（是 / 不是 / 不重要 / 是也不是）一步步还原故事真相，支持历史会话恢复和按对话生成配图。

---

## 功能概览

- **AI 主持人**
  - 自动出题：从预设题库中选择汤面（Situation）。
  - 规则裁判：只用「是 / 不是 / 不重要 / 是也不是」回答。
  - 节奏控制：识别用户「不想玩了 / 退出」等结束意图，可提示揭晓汤底。

- **游戏流程**
  - 选择汤类型：清汤（轻量） / 红汤·黑汤（重口味、恐怖悬疑）。
  - 展示汤面：展示离奇故事片段作为起点。
  - 多轮问答：用户通过封闭式提问探索线索。
  - 揭晓汤底：用户主动请求时展示完整真相，并支持复盘本局提问记录。

- **会话与历史**
  - 会话持久化：所有会话与消息写入 MySQL。
  - 历史列表：按用户列出过往对局，可再次进入查看详情。
  - 恢复对话：重新打开旧会话时，完整还原问答记录与汤面。

- **图片生成（后续版本）**
  - 基于汤面 / 汤底 / 会话总结生成配图。
  - 在会话内展示，并支持下载或分享。

---

## 系统架构

- **前端 Web 应用**
  - 技术栈：Next.js (React) + TypeScript + Tailwind CSS。
  - 职责：
    - 实现「选汤类型」「游戏主界面」「历史会话」等页面。
    - 通过 REST API 和 SSE 接收/发送消息与流式 AI 回复。
    - 管理轻量本地状态（当前会话 ID、匿名用户标识等）。

- **后端服务（haiguitang-server）**
  - 技术栈：Node.js + Fastify / Nest.js。
  - 职责：
    - 提供 REST API 与 SSE 流式接口。
    - 管理会话（sessions）、消息（messages）、题库（puzzles）、会话配图（session_images）。
    - 封装大模型调用（Prompt 管理、重试与模型切换）。

- **数据库**
  - MySQL。
  - 表结构（详见 `DATABASE.md`）：
    - `users`：用户/匿名设备标识。
    - `puzzles`：预设题库（汤面/汤底、类型、难度、标签等）。
    - `sessions`：一局游戏一条会话，关联用户与题目。
    - `messages`：问答消息记录。
    - `session_images`：会话配图（后续版本）。

- **外部服务**
  - 大模型 / 图片生成 API（OpenAI 兼容或其他）。
  - 日志与错误追踪服务（如 Sentry）。

---

## 核心设计要点

- **AI 主持人**
  - Prompt 中包含游戏规则、汤面（surface）、汤底（bottom，仅内部参考）。
  - 结合历史消息上下文，输出符合规则的回答。
  - 识别退出 / 结束意图并结束会话，引导用户再来一局或返回大厅。

- **持久化与恢复**
  - 所有消息按会话 ID 顺序写入 `messages` 表。
  - 历史会话按 `user_id + created_at` 倒序查询。
  - 恢复对话时按时间顺序返回消息列表，前端直接重放。

- **性能与体验**
  - 使用 SSE（Server-Sent Events）流式推送 AI 回复，降低等待感。
  - 数据库连接池与必要索引保障基础性能。
  - 全局异常捕获 + 结构化日志，保证线上可观测性。

- **安全与隔离**
  - 通过 `X-External-Id` / 用户 ID 关联 `users` 表，实现“按用户隔离会话”。
  - 汤底（bottom）仅在揭晓接口中返回，其余接口均不暴露。
  - 预留 JWT / 更强鉴权方案扩展位。

---

## 技术栈

- **前端**
  - Next.js (React 18+)
  - TypeScript
  - Tailwind CSS
  - Axios / Fetch 封装

- **后端**
  - Node.js 18+ / 20+
  - Fastify 或 Nest.js
  - MySQL + mysql2 / Prisma
  - OpenAI 兼容 SDK（或厂商 SDK）
  - pino / winston（日志）、Sentry（错误追踪）

- **基础设施**
  - Docker 镜像构建与部署
  - 预留 K8s / 容器编排能力

---

## 接口文档

所有对外 HTTP / SSE 接口定义见：

- `API_SPEC.md`

包含内容：
- 鉴权与错误码约定
- 会话相关接口：创建、新增问题、历史列表、详情、退出、揭晓汤底
- 消息接口：拉取消息、非流式提问 / 流式 SSE 提问
- 会话配图接口（V1.1）

---

## 数据模型

数据库表结构与字段定义见：

- `DATABASE.md`

核心实体：
- `users`：用户 / 匿名设备
- `puzzles`：海龟汤题库
- `sessions`：一局游戏
- `messages`：每条问答
- `session_images`：生成图片（可选）

---

## 开发计划与版本划分

- **MVP（V1.0）**
  - 海龟汤核心单人玩法
  - 题库选题 + 会话/消息持久化
  - 历史会话列表与恢复
  - AI 主持人（出题 + 裁判 + 结束识别）
  - 基本日志与异常处理

- **V1.1**
  - 会话配图生成与展示
  - AI 模型切换 / 降级策略

- **后续（V1.x）**
  - 题目管理后台 / 用户自定义题目
  - 多人同局玩法
  - 简单数据统计与成就系统

---

## 相关文档

- 产品需求文档：`prd.md`
- 技术设计说明：`TECH_DESIGN.md`
- 数据库设计：`DATABASE.md`
- API 规格：`API_SPEC.md`