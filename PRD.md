# 海龟汤 产品需求文档（PRD）

**文档版本**：v1.0  
**最后更新**：2025-02-10

---

## 1. 产品概述与目标用户

### 1.1 产品概述

**海龟汤**（Situation Puzzle）是一款基于 AI 主持人的情境推理游戏产品，俗称水平思考游戏或「是/不是」游戏。产品将经典线下/社交场景中的海龟汤玩法搬到线上，由 AI 担任出题者与裁判，用户通过封闭式提问逐步还原故事真相，并支持选择汤的类型、查看历史对话、为对话生成配图等能力。

**核心价值**：
- **单人可玩**：无需真人出题者，随时可与 AI 对局。
- **逻辑与联想训练**：锻炼封闭式提问、逻辑还原和发散思维。
- **轻社交与内容沉淀**：历史对话可回顾，支持为故事生成图片，便于分享与二次传播。

### 1.2 游戏机制简述

| 要素 | 说明 |
|------|------|
| **汤面 (Situation)** | 一段碎片化、逻辑不通、令人费解的诡异叙述，即「题目」。 |
| **汤底 (Answer)** | 汤面背后逻辑合理、悬疑或恐怖的完整故事真相。 |
| **互动规则** | 猜题者以封闭式提问（如「这个人是女的吗？」）探索线索；出题者仅能回答「是」「不是」「不重要」或「是也不是」。 |
| **类型** | **清汤**：无尸体、较为平淡的剧情；**红汤/黑汤**：涉及恐怖、悬疑、血腥或沉重逻辑的重口味故事。 |

**名称典故**：经典逻辑题「海龟汤」——一名男子在餐厅喝了一碗海龟汤，吃了几口后自杀；原因是他曾因海难被困，同伴将其父肉煮成「海龟汤」让他存活，再次喝到真正海龟汤时真相败露。

### 1.3 目标用户

| 用户类型 | 特征与需求 |
|----------|-------------|
| **推理/解谜爱好者** | 喜欢剧本杀、密室、逻辑题，希望有高质量题目与稳定规则。 |
| **轻度社交/聚会用户** | 聚会、连麦时想快速开局，无需事先准备题目。 |
| **内容消费者/创作者** | 喜欢看或产出「海龟汤」故事与配图，用于分享或二创。 |
| **教育/培训场景** | 用于思维训练、破冰或团队活动。 |

---

## 2. 详细功能列表

### 2.1 游戏流程与核心玩法

| 功能编号 | 功能名称 | 功能描述 | 备注 |
|----------|----------|----------|------|
| F-1.1 | 汤类型选择 | 进入游戏前可选择「清汤」或「红汤/黑汤」，影响题目风格与难度。 | 必选其一才能开始。 |
| F-1.2 | 汤面展示 | 展示当前局的汤面（诡异叙述），作为猜题起点。 | 预设题库提供。 |
| F-1.3 | 封闭式提问 | 用户输入问题，系统约束为封闭式（是/否可回答）。 | 可做简单校验或提示。 |
| F-1.4 | 标准回答 | AI 仅以「是」「不是」「不重要」「是也不是」作答，不剧透汤底。 | 核心规则，需在 Prompt/规则中固化。 |
| F-1.5 | 揭晓汤底 | 用户可主动请求揭晓，或 AI 判断已推理出真相时提示揭晓。 | 可设「请求揭晓」按钮。 |
| F-1.6 | 结束与复盘 | 一局结束后可查看完整汤底与提问记录，支持再来一局或返回大厅。 | 可带简单统计（提问次数、用时等）。 |

### 2.2 对话与会话管理

| 功能编号 | 功能名称 | 功能描述 | 备注 |
|----------|----------|----------|------|
| F-2.1 | 当前对话进行 | 单局内多轮问答，消息按时间顺序展示，区分用户与 AI。 | 支持文本气泡或列表。 |
| F-2.2 | 历史会话列表 | 用户可查看「之前的聊天」列表，按时间或标题展示。 | 支持分页或滚动加载。 |
| F-2.3 | 恢复历史对话 | 点击某条历史会话可恢复该会话的完整内容与进度。 | 依赖持久化（见 F-3.x）。 |
| F-2.4 | 新开一局 | 从大厅或本局结束后可新开一局，重新选汤类型并获取新汤面。 | 旧会话保留在历史中。 |

### 2.3 持久化与多端一致

| 功能编号 | 功能名称 | 功能描述 | 备注 |
|----------|----------|----------|------|
| F-3.1 | 对话持久化 | 将用户每一次对话与消息保存至数据库（如 MySQL）。 | 刷新/换设备后可找回。 |
| F-3.2 | 会话与消息结构 | 支持会话（Session）与消息（Message）两级结构，便于按会话维度查询与恢复。 | 见 DATABASE 设计。 |

### 2.4 AI 主持人能力

| 功能编号 | 功能名称 | 功能描述 | 备注 |
|----------|----------|----------|------|
| F-4.1 | AI 出题与裁判 | AI 负责给出汤面、按规则回答是/否、在适当时机揭晓汤底。 | 需持续把对话上下文与规则注入 Prompt。 |
| F-4.2 | 结束意图识别 | 当用户表达「退出」「不想玩了」「结束」等时，AI 识别并结束本局，不强行继续。 | 可结合关键词 + 语义。 |
| F-4.3 | 调用失败重试 | 调用 AI 失败时自动重试（有限次数），避免单次网络/服务波动导致断局。 | 见技术方案中的稳定性。 |
| F-4.4 | 模型切换（可选） | 若当前模型不可用或体验差，支持切换备用 AI 模型。 | 可为后续版本或配置项。 |

### 2.5 图片生成

| 功能编号 | 功能名称 | 功能描述 | 备注 |
|----------|----------|----------|------|
| F-5.1 | 按对话生成图片 | 根据当前对话内容（汤面/汤底/关键情节）生成一张配图。 | 可在揭晓后或用户主动触发。 |
| F-5.2 | 图片展示与下载 | 生成后的图片在会话内展示，支持保存到本地或分享。 | 需注意版权与内容安全。 |

### 2.6 系统与运维支撑

| 功能编号 | 功能名称 | 功能描述 | 备注 |
|----------|----------|----------|------|
| F-6.1 | 操作与 AI 反馈日志 | 对用户关键操作及 AI 反馈生成日志，便于排查与分析。 | 可落库或日志系统。 |
| F-6.2 | 异常捕获与提示 | 捕获异常并向前端返回友好错误信息，避免白屏或裸报错。 | 如「服务暂时不可用，请稍后再试」。 |

---

## 3. 功能优先级（MVP 与后续版本）

### 3.1 MVP（第一版必须）

目标：**可玩、可存、可恢复**，保证核心体验闭环。

| 优先级 | 功能编号 | 功能名称 |
|--------|----------|----------|
| P0 | F-1.1 | 汤类型选择（清汤 / 红汤·黑汤） |
| P0 | F-1.2 | 汤面展示 |
| P0 | F-1.3 | 封闭式提问 |
| P0 | F-1.4 | 标准回答（是/不是/不重要/是也不是） |
| P0 | F-1.5 | 揭晓汤底 |
| P0 | F-1.6 | 结束与复盘（含再来一局） |
| P0 | F-2.1 | 当前对话进行（多轮问答展示） |
| P0 | F-2.2 | 历史会话列表 |
| P0 | F-2.3 | 恢复历史对话 |
| P0 | F-2.4 | 新开一局 |
| P0 | F-3.1 | 对话持久化（MySQL） |
| P0 | F-3.2 | 会话与消息数据结构 |
| P0 | F-4.1 | AI 出题与裁判 |
| P0 | F-4.2 | 结束意图识别（退出/不想玩） |
| P0 | F-4.3 | AI 调用失败重试 |
| P0 | F-6.2 | 异常捕获与用户提示 |

### 3.2 后续版本

| 版本 | 功能编号 | 功能名称 | 说明 |
|------|----------|----------|------|
| V1.1 | F-5.1, F-5.2 | 按对话生成图片、展示与下载 | 提升传播与趣味性 |
| V1.1 | F-4.4 | 模型切换 | 提升可用性与容灾 |
| V1.2 | F-6.1 | 操作与 AI 反馈日志 | 运营与问题排查 |
| V1.x | — | 题目库/自定义汤面 | 用户或运营上传题目，AI 仅做裁判 |
| V1.x | — | 多人同局（同一汤面竞猜） | 需房间与回合设计 |
| V1.x | — | 简单数据统计 | 如每局提问数、用时、正确率等 |

---

## 4. 界面设计要求

### 4.1 整体风格

- **氛围**：贴合「悬疑/推理」而不阴森，清汤偏轻量、红汤/黑汤可略暗色与对比强。
- **信息层级**：汤面 > 当前问答流 > 操作区（输入、揭晓、结束）；历史会话入口清晰但不抢主流程。
- **一致性**：与产品名称「海龟汤」和类型选择（清汤/红汤）在视觉上有一致隐喻（如颜色、图标）。

### 4.2 核心页面与组件

| 页面/区域 | 要求 |
|-----------|------|
| **首页/大厅** | 突出「选汤类型」入口（清汤 / 红汤·黑汤），次要入口：历史会话列表、新开一局。 |
| **游戏主界面** | 顶部或固定区展示当前汤面；中部为对话流（用户与 AI 气泡区分明显）；底部为输入框 + 发送 + 可选「揭晓」「结束本局」。 |
| **对话气泡** | 用户与 AI 左右或样式区分（颜色/图标），时间或序号可选显示；AI 回答需强调「是/不是/不重要/是也不是」的展示。 |
| **历史会话** | 列表项包含：标题（可取自汤面摘要或时间）、时间、可选缩略图；点击进入即恢复该会话。 |
| **揭晓/结束** | 汤底以可折叠或高亮块展示；结束后提供「再来一局」「返回大厅」「查看历史」等按钮。 |

### 4.3 交互与体验

- **输入**：支持回车发送；提交后输入框禁用或显示「思考中」直至 AI 回复。
- **加载与等待**：AI 思考时使用加载态（如骨架屏、打字机效果或明确「AI 正在思考」），避免长时间无反馈。
- **错误态**：网络或 AI 失败时，在对话流或顶部 toast 提示重试或「稍后再试」，不白屏。
- **无障碍**：关键按钮具备可聚焦与语义化标签；颜色不作为唯一信息区分（配合图标/文案）。

### 4.4 响应式与多端

- **优先**：移动端竖屏（375px–428px）与平板/桌面（768px+）布局适配，无横向溢出。
- **触控**：按钮与可点击区域足够大（建议 ≥44px），间距合理防止误触。

---

## 5. 技术栈建议

### 5.1 前端

| 类别 | 建议 | 说明 |
|------|------|------|
| 框架 | React / Next.js 或 Vue 3 | 便于组件化与状态管理，Next 利于 SEO 与 API 聚合。 |
| 样式 | Tailwind CSS + 设计 tokens | 快速实现 4.2 中的双风格（清汤/红汤），易做主题切换。 |
| 状态 | React Query / SWR 或 Pinia | 会话列表、当前对话、加载与错误态统一管理。 |
| 实时体验 | SSE 或 WebSocket | 流式输出 AI 回复，配合「打字机」展示。 |

### 5.2 后端

| 类别 | 建议 | 说明 |
|------|------|------|
| 语言/框架 | Java (Spring Boot) 或 Node (Nest.js/Fastify) | 与现有 TECH_DESIGN 中的线程池、连接池、SSE 方案匹配。 |
| API 风格 | REST + 流式端点 | 例如 `POST /api/sessions`、`POST /api/sessions/:id/messages`，流式回复单独端点。 |
| 持久化 | MySQL | 会话表 + 消息表，支持按用户/时间查询与恢复（见 DATABASE）。 |
| AI 调用 | 统一 AI 网关或 SDK | 封装重试、超时、模型切换（F-4.3、F-4.4）。 |

### 5.3 基础设施与运维

| 类别 | 建议 | 说明 |
|------|------|------|
| 部署 | 容器化 (Docker) + 单机或小规模 K8s | 便于扩展与回滚。 |
| 日志与监控 | 结构化日志 + 错误追踪（如 Sentry） | 支撑 F-6.1 与线上排查。 |
| 性能 | 连接池 + 线程池、SSE 流式、异步非阻塞 | 与 TECH_DESIGN 中「性能优化」一致。 |

---

## 6. 非功能性需求

### 6.1 性能

| 指标 | 要求 |
|------|------|
| 首屏/可交互 | 首屏或首条消息可交互时间 &lt; 3s（常规网络）。 |
| AI 首 token | 流式场景下首字/首 token 延迟 &lt; 2s。 |
| 列表与恢复 | 历史会话列表加载 &lt; 1s；恢复单会话 &lt; 2s。 |
| 并发 | MVP 阶段可按单机数百并发设计，为扩展预留接口与无状态设计。 |

**实现要点**：SSE 实时推送、异步处理、DB 连接池与索引（如 `user_id + created_at`）。

### 6.2 安全

| 类别 | 要求 |
|------|------|
| 身份与鉴权 | 用户会话与消息按用户隔离；敏感接口需登录态或 Token 校验。 |
| 输入校验 | 对用户输入做长度、敏感词与格式校验，防止注入与滥用。 |
| 内容安全 | 汤面/汤底及生成图片需符合内容安全策略（对接审核或过滤）。 |
| 数据与隐私 | 对话数据加密存储与传输（HTTPS、敏感字段加密）；合规保留与删除策略。 |

### 6.3 可用性与稳定性

| 类别 | 要求 |
|------|------|
| AI 可用性 | 调用失败自动重试（如 2–3 次），必要时降级提示或切换模型。 |
| 错误处理 | 全局异常捕获，对用户展示友好提示，不暴露内部堆栈。 |
| 依赖故障 | DB/缓存短暂不可用时，可返回「服务繁忙」而非 500 白屏。 |

### 6.4 可维护与可观测

| 类别 | 要求 |
|------|------|
| 日志 | 关键操作与 AI 请求/响应（可脱敏）留痕，便于排查与后续 F-6.1。 |
| 监控 | 接口耗时、错误率、AI 调用成功率可观测（如 Prometheus + Grafana）。 |

---

## 附录：与现有文档的对应关系

- **TECH_DESIGN.md**：AI 主持人、持久化、工具类（日志、异常、性能）在本 PRD 中对应 F-4.x、F-3.x、F-6.x 及第 5、6 章。
- **DATABASE.md**：会话与消息的持久化结构可在 DATABASE 中细化表结构（用户、会话、消息、可选图片）。
- 本 PRD 中的「历史会话」「恢复对话」「每段对话可生成相应图片」与现有 PRD 描述一致，并拆解为可开发的功能项与优先级。
